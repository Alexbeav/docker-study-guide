# Docker 3 Host VM Lab (Vagrant + VirtualBox)

This lab environment provisions **three Ubuntu 24.04 VMs** using Vagrant and VirtualBox, ideal for Docker Swarm or multi-host Docker testing.

## Features

- **3x Ubuntu 24.04 VMs** (docker01, docker02, docker03)
- Static IPs: `172.16.3.101`, `172.16.3.102`, `172.16.3.103`
- Bridged networking via `Hyper-V Virtual Ethernet Adapter #3`
- Each VM: 4096MB RAM, 2 CPUs
- Docker CE, Docker Compose, and UFW pre-installed and configured
- SSH key-based access (public key: `dockerlab_key.pub`)
- UFW allows SSH (22/tcp) and ICMP (ping)
- Default gateway: `172.16.1.1`, subnet mask: `255.255.252.0`

## Prerequisites

- [VirtualBox](https://www.virtualbox.org/) installed
- [Vagrant](https://www.vagrantup.com/) installed
- The network adapter `Hyper-V Virtual Ethernet Adapter #3` connected to your LAN
- `dockerlab_key.pub` (your SSH public key) in the `vagrant` directory

## Usage

1. **Clone this repository and open a terminal in the `vagrant` directory.**

2. **Bring up the VMs in parallel:**
   ```sh
   vagrant up --parallel --provider=virtualbox
   ```

3. **Access a VM:**
   ```sh
   vagrant ssh docker01
   ```

4. **Check VM status:**
   ```sh
   vagrant status
   ```

5. **Halt all VMs:**
   ```sh
   vagrant halt
   ```

6. **Destroy all VMs:**
   ```sh
   vagrant destroy -f
   ```

## Network Details

| VM Name   | Hostname   | IP Address      |
|-----------|------------|-----------------|
| docker01  | docker01   | 172.16.3.101    |
| docker02  | docker02   | 172.16.3.102    |
| docker03  | docker03   | 172.16.3.103    |

- **Subnet Mask:** 255.255.252.0
- **Gateway:** 172.16.1.1

## Notes

- The VMs are accessible from your LAN at their static IPs.
- Docker is installed using the official Docker repository.
- UFW is enabled and allows SSH and ping.
- If you change the network adapter name or IP range, update the Vagrantfile accordingly.

---

## Full Vagrantfile

```
VAGRANTFILE_API_VERSION = "2"

  

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  config.vm.box = "bento/ubuntu-24.04"

  config.ssh.insert_key = false  # We'll use our own SSH key

  

  (1..3).each do |i|

    config.vm.define "docker0#{i}" do |node|

      node.vm.hostname = "docker0#{i}"

      node.vm.network "public_network", ip: "172.16.3.10#{i}", netmask: "255.255.252.0", gateway: "172.16.1.1", bridge: "Hyper-V Virtual Ethernet Adapter #3"

      node.vm.communicator = "ssh"

  

      node.vm.provider "virtualbox" do |vb|

        vb.memory = 4096

        vb.cpus = 2

      end

  

      # Upload public SSH key

      node.vm.provision "file",

        source: "dockerlab_key.pub",

        destination: "/home/vagrant/dockerlab_key.pub"

  

      # Install Docker using official repo, set up SSH key, and fix default gateway

      node.vm.provision "shell", inline: <<-SHELL

        export DEBIAN_FRONTEND=noninteractive

        apt-get update

        apt-get install -y \\

          ca-certificates \\

          curl \\

          gnupg \\

          lsb-release \\

          ufw

        mkdir -p /etc/apt/keyrings

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

        apt-get update

        apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

        usermod -aG docker vagrant

        systemctl enable docker

        systemctl start docker

        mkdir -p /home/vagrant/.ssh

        cat /home/vagrant/dockerlab_key.pub >> /home/vagrant/.ssh/authorized_keys

        chown -R vagrant:vagrant /home/vagrant/.ssh

        chmod 700 /home/vagrant/.ssh

        chmod 600 /home/vagrant/.ssh/authorized_keys

  

        # Allow SSH and ICMP (ping) in UFW

        ufw allow 22/tcp

        ufw allow proto icmp

        ufw --force enable

  

        # Fix default gateway to use eth1 (bridged adapter)

        ip route del default via 10.0.2.2 dev eth0 || true

        ip route add default dev eth1 || true

  

        echo "==== Custom Provisioning Output ===="

        echo "Hostname: $(hostname)"

        echo "IP addresses: $(hostname -I)"

        echo "Default route: $(ip route | grep default)"

        echo "Docker version: $(docker --version 2>/dev/null || echo 'Docker not installed')"

        echo "===================================="

      SHELL

    end

  end

end
```